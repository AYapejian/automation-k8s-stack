name: PR Validation

on:
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'specs/**'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: |
          echo "Running yamllint..."
          yamllint -c .yamllint.yaml . && echo "YAML lint: PASSED"

      - name: Validate Makefile exists
        run: |
          test -f Makefile && echo "Makefile exists" || exit 1

      - name: Show make targets
        run: make help

  # Fast core platform test - validates essential components only
  # Full observability stack tested in extended-integration.yaml
  core-platform-test:
    name: Core Platform Test
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 8
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create k3d cluster
        uses: AbsaOSS/k3d-action@v2.4.0
        with:
          cluster-name: automation-k8s
          k3d-version: v5.7.4
          args: --config clusters/k3d/cluster-config.yaml

      - name: Install Helm and tools
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version
          jq --version

      # ===== PLATFORM LAYER =====
      - name: Install Istio
        run: make istio-up

      - name: Verify Istio
        run: |
          kubectl wait --for=condition=Ready pods --all -n istio-system --timeout=120s
          kubectl wait --for=condition=Ready pods --all -n istio-ingress --timeout=120s
          # Verify mTLS
          MTLS_MODE=$(kubectl get peerauthentication default -n istio-system -o jsonpath='{.spec.mtls.mode}')
          [ "$MTLS_MODE" = "STRICT" ] && echo "mTLS STRICT verified"

      - name: Install cert-manager
        run: make cert-manager-up

      - name: Verify cert-manager
        run: |
          kubectl wait --for=condition=Ready pods --all -n cert-manager --timeout=120s
          kubectl wait --for=condition=Ready clusterissuer/selfsigned-issuer --timeout=60s
          kubectl wait --for=condition=Ready clusterissuer/automation-ca-issuer --timeout=60s

      - name: Configure ingress
        run: make ingress-up

      - name: Verify ingress certificate
        run: |
          kubectl wait --for=condition=Ready certificate/gateway-tls -n istio-ingress --timeout=120s
          kubectl get secret gateway-tls-secret -n istio-ingress

      # ===== SAMPLE APP TEST =====
      - name: Deploy sample app
        run: make sample-app-up

      - name: Test ingress routing
        run: |
          kubectl wait --for=condition=Ready pods -l app=httpbin -n ingress-sample --timeout=60s

          # Verify TLS secret exists (pre-requisite for HTTPS)
          echo "Verifying TLS secret..."
          kubectl get secret gateway-tls-secret -n istio-ingress || {
            echo "TLS secret not found - certificate may not have issued"
            exit 1
          }

          # Verify Gateway pod has correct label for selector match
          echo "Verifying Gateway pod labels..."
          kubectl get pods -n istio-ingress -l istio=gateway --no-headers || {
            echo "No pods with label istio=gateway found!"
            kubectl get pods -n istio-ingress --show-labels
            exit 1
          }

          # Test HTTPS with retries (config propagation typically < 15s)
          echo "Testing HTTPS ingress..."
          ROUTING_VERIFIED=false
          for i in {1..3}; do
            RESPONSE=$(curl -sk -H "Host: httpbin.localhost" https://localhost:8443/get 2>/dev/null || true)
            if echo "$RESPONSE" | jq -e '.url' >/dev/null 2>&1; then
              echo "HTTPS routing verified on attempt $i"
              ROUTING_VERIFIED=true
              break
            fi
            echo "Retry $i/3..."
            sleep 5
          done

          if [ "$ROUTING_VERIFIED" != "true" ]; then
            echo "HTTPS routing failed"
            echo "Response: $RESPONSE"
            kubectl get pods -n istio-ingress -o wide
            kubectl get gateway -A
            exit 1
          fi

          # Verify sidecar injection
          CONTAINERS=$(kubectl get pod -l app=httpbin -n ingress-sample -o jsonpath='{.items[0].spec.containers[*].name}')
          echo "$CONTAINERS" | grep -q "istio-proxy" && echo "Sidecar injection verified"

      # ===== SUMMARY =====
      - name: Print stack status
        if: always()
        run: |
          echo "=== Final Stack Status ==="
          if ! kubectl get pods -A 2>/dev/null | grep -v "Completed"; then
            echo "Warning: Could not retrieve pod status"
          fi
          echo ""
          echo "=== Helm Releases ==="
          if ! helm list -A 2>/dev/null; then
            echo "Warning: Could not retrieve Helm releases"
          fi

      - name: Cleanup
        if: always()
        run: |
          make sample-app-down || true
          make ingress-down || true
          make cert-manager-down || true
          make istio-down || true
          make cluster-down
