name: Extended Integration

# Full integration tests - runs on merge to main, nightly, or ArgoCD/platform/observability PRs
# For fast PR validation, see pr-validation.yaml
# Deployment is GitOps-driven: ArgoCD manages all cluster resources

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:
  pull_request:
    branches: [main]
    paths:
      - 'argocd/**'
      - 'platform/**'
      - 'observability/**'
      - 'apps/**'
      - 'scripts/argocd-*.sh'
      - 'scripts/cluster-*.sh'
      - 'scripts/stack-*.sh'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: |
          echo "Running yamllint..."
          yamllint -c .yamllint.yaml . && echo "YAML lint: PASSED"

      - name: Validate Makefile exists
        run: |
          test -f Makefile && echo "Makefile exists" || exit 1

      - name: Show make targets
        run: make help

  # Extended integration test - validates full stack via ArgoCD GitOps
  # ArgoCD manages all resources: platform, observability, and workloads
  # Sync waves ensure correct deployment order
  integration-test:
    name: Extended Integration
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install prerequisites
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          k3d version
          helm version
          jq --version

      - name: Create k3d cluster
        run: make cluster-up

      # ===== ARGOCD GITOPS DEPLOYMENT =====
      - name: Bootstrap ArgoCD
        run: make argocd-up

      - name: Verify ArgoCD is running
        run: |
          echo "Verifying ArgoCD components..."
          # Wait for specific deployments (excludes Completed job pods)
          kubectl wait --for=condition=Available deployment/argocd-server -n argocd --timeout=180s
          kubectl wait --for=condition=Available deployment/argocd-repo-server -n argocd --timeout=180s
          kubectl wait --for=condition=Available deployment/argocd-applicationset-controller -n argocd --timeout=180s
          kubectl wait --for=condition=Ready pod -l app.kubernetes.io/name=argocd-application-controller -n argocd --timeout=180s
          echo "ArgoCD is ready"

      - name: Apply root application
        run: |
          echo "Applying root app-of-apps..."
          kubectl apply -f argocd/applications/root-app.yaml
          echo "Root application applied"

      - name: Wait for ArgoCD sync (platform layer)
        run: |
          echo "Waiting for platform components to sync..."
          # Wait for Istio CRDs first (sync wave 0)
          echo "Waiting for Istio base..."
          timeout 180 bash -c 'until kubectl get crd gateways.networking.istio.io 2>/dev/null; do sleep 5; done' || true

          # Wait for Istio control plane (sync wave 1)
          echo "Waiting for Istiod..."
          kubectl wait --for=condition=Ready pods -l app=istiod -n istio-system --timeout=180s || true

          # Wait for cert-manager (sync wave 2)
          echo "Waiting for cert-manager..."
          kubectl wait --for=condition=Ready pods --all -n cert-manager --timeout=180s || true

          # Wait for Istio gateway (sync wave 4)
          echo "Waiting for Istio gateway..."
          kubectl wait --for=condition=Ready pods --all -n istio-ingress --timeout=120s || true

          echo "Platform layer synced"

      - name: Wait for ArgoCD sync (observability layer)
        run: |
          echo "Waiting for observability components to sync..."
          # Allow time for sync wave 10-11 to start
          sleep 30

          # Wait for Prometheus (sync wave 10)
          echo "Waiting for Prometheus..."
          kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=prometheus -n observability --timeout=180s || true

          # Wait for Grafana (sync wave 10)
          echo "Waiting for Grafana..."
          kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=grafana -n observability --timeout=180s || true

          echo "Observability layer synced"

      - name: Wait for ArgoCD sync (workloads layer)
        run: |
          echo "Waiting for workload applications to sync..."
          # Allow time for sync wave 20 to start
          sleep 30

          # Wait for Home Automation components
          echo "Waiting for Mosquitto MQTT..."
          kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=mosquitto -n home-automation --timeout=120s || true

          echo "Waiting for HomeAssistant..."
          kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=homeassistant -n home-automation --timeout=180s || true

          echo "Waiting for sample app..."
          kubectl wait --for=condition=Ready pods -l app=httpbin -n ingress-sample --timeout=120s || true

          echo "Workloads layer synced"

      # ===== VERIFICATION TESTS =====
      - name: Verify Istio mTLS
        run: |
          MTLS_MODE=$(kubectl get peerauthentication default -n istio-system -o jsonpath='{.spec.mtls.mode}' 2>/dev/null || echo "NOTFOUND")
          if [ "$MTLS_MODE" = "STRICT" ]; then
            echo "✓ mTLS STRICT verified"
          else
            echo "⚠ mTLS mode: $MTLS_MODE (expected STRICT)"
          fi

      - name: Verify cert-manager
        run: |
          kubectl get clusterissuers || echo "ClusterIssuers not yet available"
          kubectl get certificates -A || echo "Certificates not yet available"

      - name: Test ingress routing
        run: |
          echo "Testing HTTPS ingress..."
          # Test with retries since apps may still be starting
          for i in {1..5}; do
            RESPONSE=$(curl -sk -H "Host: httpbin.localhost" https://localhost:8443/get 2>/dev/null || true)
            if echo "$RESPONSE" | jq -e '.url' >/dev/null 2>&1; then
              echo "✓ HTTPS routing verified"
              break
            fi
            echo "Retry $i/5..."
            sleep 10
          done

          # Verify sidecar injection
          CONTAINERS=$(kubectl get pod -l app=httpbin -n ingress-sample -o jsonpath='{.items[0].spec.containers[*].name}' 2>/dev/null || true)
          if echo "$CONTAINERS" | grep -q "istio-proxy"; then
            echo "✓ Sidecar injection verified"
          else
            echo "⚠ Sidecar not found (may still be injecting)"
          fi

      - name: Test MQTT connectivity
        run: |
          echo "Testing MQTT broker connectivity..."
          MQTT_POD=$(kubectl get pods -n home-automation -l app.kubernetes.io/name=mosquitto -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
          if [ -n "$MQTT_POD" ]; then
            kubectl exec -n home-automation "$MQTT_POD" -c mosquitto -- \
              mosquitto_pub -h localhost -p 1883 -t "ci/test" -m "hello" -q 1 || true
            echo "✓ MQTT connectivity verified"
          else
            echo "⚠ Mosquitto pod not found"
          fi

      - name: Test ArgoCD idempotency
        run: |
          echo "Testing ArgoCD idempotency (re-bootstrap)..."
          make argocd-up
          echo "✓ ArgoCD bootstrap is idempotent"

      # ===== ARGOCD STATUS =====
      - name: Show ArgoCD application status
        if: always()
        run: |
          echo "=== ArgoCD Applications ==="
          kubectl get applications -n argocd 2>/dev/null || echo "No applications found"
          echo ""
          echo "=== Application Health Summary ==="
          kubectl get applications -n argocd -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.status.health.status}{"\t"}{.status.sync.status}{"\n"}{end}' 2>/dev/null || true

      # ===== SUMMARY =====
      - name: Print stack status
        if: always()
        run: |
          echo "=== Final Stack Status ==="
          kubectl get pods -A | grep -v "Completed" || true
          echo ""
          echo "=== Helm Releases ==="
          helm list -A || true

      - name: Cleanup
        if: always()
        run: |
          # ArgoCD manages all resources, just tear down the cluster
          make cluster-down
