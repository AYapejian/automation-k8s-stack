name: Extended Integration

# Full integration tests - runs on merge to main, nightly, or observability PRs
# For fast PR validation, see pr-validation.yaml

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:
  pull_request:
    branches: [main]
    paths:
      - 'observability/**'
      - 'platform/minio/**'
      - 'platform/velero/**'
      - 'apps/home-automation/**'
      - 'scripts/prometheus-*.sh'
      - 'scripts/loki-*.sh'
      - 'scripts/tracing-*.sh'
      - 'scripts/minio-*.sh'
      - 'scripts/velero-*.sh'
      - 'scripts/home-automation-*.sh'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate YAML syntax
        run: |
          echo "Checking for YAML syntax errors..."
          find . -name '*.yaml' -o -name '*.yml' | while read file; do
            python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null || echo "Warning: $file may have issues"
          done
          echo "YAML validation complete"

      - name: Validate Makefile exists
        run: |
          test -f Makefile && echo "Makefile exists" || exit 1

      - name: Show make targets
        run: make help

  # Extended integration test - validates full stack including observability
  # Includes Minio, Prometheus, Grafana, and idempotency tests
  # Note: Loki, Tracing, and Velero excluded due to CI runner resource constraints
  integration-test:
    name: Extended Integration
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install prerequisites
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          k3d version
          helm version
          jq --version

      - name: Create k3d cluster
        run: make cluster-up

      # ===== PLATFORM LAYER =====
      - name: Install Istio
        run: make istio-up

      - name: Verify Istio
        run: |
          kubectl wait --for=condition=Ready pods --all -n istio-system --timeout=120s
          kubectl wait --for=condition=Ready pods --all -n istio-ingress --timeout=120s
          # Verify mTLS
          MTLS_MODE=$(kubectl get peerauthentication default -n istio-system -o jsonpath='{.spec.mtls.mode}')
          [ "$MTLS_MODE" = "STRICT" ] && echo "mTLS STRICT verified"

      - name: Install cert-manager
        run: make cert-manager-up

      - name: Verify cert-manager
        run: |
          kubectl wait --for=condition=Ready pods --all -n cert-manager --timeout=120s
          kubectl wait --for=condition=Ready clusterissuer/selfsigned-issuer --timeout=60s
          kubectl wait --for=condition=Ready clusterissuer/automation-ca-issuer --timeout=60s

      - name: Configure ingress
        run: make ingress-up

      - name: Verify ingress certificate
        run: |
          kubectl wait --for=condition=Ready certificate/gateway-tls -n istio-ingress --timeout=120s
          kubectl get secret gateway-tls-secret -n istio-ingress

      - name: Install Minio
        run: make minio-up

      - name: Verify Minio
        run: |
          kubectl wait --for=condition=Ready pods -l release=minio -n minio --timeout=180s
          sleep 20  # Wait for bucket creation
          kubectl run minio-health \
            --image=curlimages/curl:latest \
            --restart=Never --rm -i --quiet \
            --namespace minio \
            -- curl -sf "http://minio.minio.svc.cluster.local:9000/minio/health/live"
          echo "Minio healthy"

      # ===== SAMPLE APP TEST =====
      - name: Deploy sample app
        run: make sample-app-up

      - name: Test ingress routing
        run: |
          kubectl wait --for=condition=Ready pods -l app=httpbin -n ingress-sample --timeout=120s
          # Test HTTPS
          RESPONSE=$(curl -sk -H "Host: httpbin.localhost" https://localhost:8443/get)
          echo "$RESPONSE" | jq -e '.url' && echo "HTTPS routing verified"
          # Verify sidecar injection
          CONTAINERS=$(kubectl get pod -l app=httpbin -n ingress-sample -o jsonpath='{.items[0].spec.containers[*].name}')
          echo "$CONTAINERS" | grep -q "istio-proxy" && echo "Sidecar injection verified"

      # ===== OBSERVABILITY (Core only) =====
      - name: Install Prometheus + Grafana
        run: make prometheus-grafana-up

      - name: Verify Prometheus + Grafana
        run: |
          kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=prometheus -n observability --timeout=180s || true
          kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=grafana -n observability --timeout=180s || true
          kubectl get pods -n observability

      # ===== HOME AUTOMATION STACK =====
      - name: Install Home Automation stack
        run: make home-automation-up

      - name: Verify Home Automation components
        run: |
          echo "Waiting for Mosquitto MQTT..."
          kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=mosquitto -n home-automation --timeout=120s
          echo "Waiting for HomeAssistant..."
          kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=homeassistant -n home-automation --timeout=180s || true
          echo "Waiting for Zigbee2MQTT..."
          kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=zigbee2mqtt -n home-automation --timeout=120s || true
          echo "Waiting for Homebridge..."
          kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=homebridge -n home-automation --timeout=120s || true
          kubectl get pods -n home-automation

      - name: Test MQTT connectivity
        run: |
          echo "Testing MQTT broker connectivity..."
          # Use kubectl exec on mosquitto pod to test MQTT is accepting connections
          MQTT_POD=$(kubectl get pods -n home-automation -l app.kubernetes.io/name=mosquitto -o jsonpath='{.items[0].metadata.name}')
          kubectl exec -n home-automation "$MQTT_POD" -c mosquitto -- \
            mosquitto_pub -h localhost -p 1883 -t "ci/test" -m "hello" -q 1
          echo "MQTT connectivity verified"

      # ===== IDEMPOTENCY TESTS =====
      - name: Test idempotency (core components)
        run: |
          echo "Testing idempotency..."
          make istio-up
          make cert-manager-up
          make ingress-up
          make minio-up
          make prometheus-grafana-up
          make home-automation-up
          echo "Core components idempotent!"

      # ===== SUMMARY =====
      - name: Print stack status
        if: always()
        run: |
          echo "=== Final Stack Status ==="
          kubectl get pods -A | grep -v "Completed" || true
          echo ""
          echo "=== Helm Releases ==="
          helm list -A || true

      - name: Cleanup
        if: always()
        run: |
          make home-automation-down || true
          make sample-app-down || true
          make prometheus-grafana-down || true
          make minio-down || true
          make ingress-down || true
          make cert-manager-down || true
          make istio-down || true
          make cluster-down
