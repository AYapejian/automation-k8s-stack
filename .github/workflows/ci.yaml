name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate YAML syntax
        run: |
          echo "Checking for YAML syntax errors..."
          find . -name '*.yaml' -o -name '*.yml' | while read file; do
            python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null || echo "Warning: $file may have issues"
          done
          echo "YAML validation complete"

      - name: Validate Makefile exists
        run: |
          test -f Makefile && echo "Makefile exists" || exit 1

      - name: Show make targets
        run: make help

  cluster-test:
    name: Cluster Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install k3d
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
          k3d version

      - name: Create k3d cluster
        run: make cluster-up

      - name: Verify cluster is ready
        run: |
          echo "Checking cluster nodes..."
          kubectl get nodes -o wide
          echo ""
          echo "Checking node labels..."
          kubectl get nodes --show-labels
          echo ""
          echo "Checking system pods..."
          kubectl get pods -n kube-system
          echo ""
          echo "Cluster info:"
          kubectl cluster-info

      - name: Test idempotency - run cluster-up again
        run: |
          echo "Running cluster-up again to verify idempotency..."
          make cluster-up
          echo "Idempotency test passed!"

      - name: Verify registry is accessible
        run: |
          echo "Checking registry..."
          k3d registry list
          echo ""
          echo "Testing registry connectivity..."
          curl -s http://localhost:5111/v2/ && echo "Registry is accessible" || echo "Registry check skipped"

      # Placeholder for actual tests (Phase 1.3)
      # - name: Run tests
      #   run: make test

      - name: Cleanup
        if: always()
        run: make cluster-down
