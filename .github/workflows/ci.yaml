name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate YAML syntax
        run: |
          echo "Checking for YAML syntax errors..."
          find . -name '*.yaml' -o -name '*.yml' | while read file; do
            python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null || echo "Warning: $file may have issues"
          done
          echo "YAML validation complete"

      - name: Validate Makefile exists
        run: |
          test -f Makefile && echo "Makefile exists" || exit 1

      - name: Show make targets
        run: make help

  cluster-test:
    name: Cluster Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install k3d and verify prerequisites
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
          k3d version
          jq --version
          echo "All prerequisites available"

      - name: Create k3d cluster
        run: make cluster-up

      - name: Verify cluster is ready
        run: |
          echo "Checking cluster nodes..."
          kubectl get nodes -o wide
          echo ""
          echo "Checking node labels..."
          kubectl get nodes --show-labels
          echo ""
          echo "Checking system pods..."
          kubectl get pods -n kube-system
          echo ""
          echo "Cluster info:"
          kubectl cluster-info

      - name: Test idempotency - run cluster-up again
        run: |
          echo "Running cluster-up again to verify idempotency..."
          make cluster-up
          echo "Idempotency test passed!"

      - name: Verify registry is accessible
        run: |
          echo "Checking registry..."
          k3d registry list
          echo ""
          echo "Testing registry connectivity..."
          curl -s http://localhost:5111/v2/ && echo "Registry is accessible" || echo "Registry check skipped"

      # Placeholder for actual tests (Phase 1.3)
      # - name: Run tests
      #   run: make test

      - name: Test storage provisioning
        run: |
          echo "Testing storage provisioning..."
          make storage-test

      - name: Cleanup storage test
        if: always()
        run: make storage-test-down || true

      - name: Cleanup
        if: always()
        run: make cluster-down

  istio-test:
    name: Istio Tests
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install prerequisites
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          k3d version
          helm version
          jq --version

      - name: Create k3d cluster
        run: make cluster-up

      - name: Install Istio
        run: make istio-up

      - name: Verify Istio control plane
        run: |
          echo "Checking Istio control plane..."
          kubectl get pods -n istio-system
          kubectl wait --for=condition=Ready pods --all -n istio-system --timeout=120s
          echo ""
          echo "Checking Istio ingress gateway..."
          kubectl get pods -n istio-ingress
          kubectl wait --for=condition=Ready pods --all -n istio-ingress --timeout=120s

      - name: Test sidecar injection
        run: |
          echo "Creating test namespace with injection enabled..."
          kubectl create namespace istio-test
          kubectl label namespace istio-test istio-injection=enabled

          echo "Deploying test workload..."
          kubectl apply -n istio-test -f - <<EOF
          apiVersion: v1
          kind: Pod
          metadata:
            name: sleep
            labels:
              app: sleep
          spec:
            containers:
            - name: sleep
              image: curlimages/curl
              command: ["/bin/sh", "-c", "sleep 3600"]
          EOF

          echo "Waiting for pod to be ready..."
          kubectl wait --for=condition=Ready pod/sleep -n istio-test --timeout=120s

          echo "Verifying sidecar injection..."
          CONTAINERS=$(kubectl get pod sleep -n istio-test -o jsonpath='{.spec.containers[*].name}')
          echo "Containers: $CONTAINERS"
          if echo "$CONTAINERS" | grep -q "istio-proxy"; then
            echo "SUCCESS: Sidecar injected!"
          else
            echo "FAILURE: Sidecar not found"
            kubectl describe pod sleep -n istio-test
            exit 1
          fi

      - name: Verify mTLS configuration
        run: |
          echo "Checking PeerAuthentication policy..."
          kubectl get peerauthentication -n istio-system

          MTLS_MODE=$(kubectl get peerauthentication default -n istio-system -o jsonpath='{.spec.mtls.mode}')
          echo "mTLS mode: $MTLS_MODE"
          if [ "$MTLS_MODE" = "STRICT" ]; then
            echo "SUCCESS: mTLS STRICT mode enforced"
          else
            echo "FAILURE: Expected STRICT, got $MTLS_MODE"
            exit 1
          fi

      - name: Test idempotency
        run: |
          echo "Running istio-up again to verify idempotency..."
          make istio-up
          echo "Idempotency test passed!"

      - name: Cleanup
        if: always()
        run: |
          kubectl delete namespace istio-test --ignore-not-found=true || true
          make istio-down || true
          make cluster-down

  ingress-test:
    name: Ingress + TLS Tests
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install prerequisites
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          k3d version
          helm version
          jq --version

      - name: Create k3d cluster
        run: make cluster-up

      - name: Install Istio
        run: make istio-up

      - name: Install cert-manager
        run: make cert-manager-up

      - name: Verify cert-manager is ready
        run: |
          echo "Checking cert-manager pods..."
          kubectl wait --for=condition=Ready pods --all -n cert-manager --timeout=120s
          echo ""
          echo "Checking ClusterIssuers..."
          kubectl wait --for=condition=Ready clusterissuer/selfsigned-issuer --timeout=60s
          kubectl wait --for=condition=Ready clusterissuer/automation-ca-issuer --timeout=60s
          echo ""
          echo "ClusterIssuers ready:"
          kubectl get clusterissuers

      - name: Configure ingress Gateway
        run: make ingress-up

      - name: Verify Gateway certificate is issued
        run: |
          echo "Checking gateway certificate..."
          kubectl wait --for=condition=Ready certificate/gateway-tls -n istio-ingress --timeout=120s
          echo ""
          echo "Certificate status:"
          kubectl get certificate -n istio-ingress
          echo ""
          echo "TLS secret created:"
          kubectl get secret gateway-tls-secret -n istio-ingress

      - name: Deploy sample application
        run: make sample-app-up

      - name: Verify sample app has sidecar
        run: |
          echo "Checking httpbin pod..."
          kubectl wait --for=condition=Ready pods -l app=httpbin -n ingress-sample --timeout=120s
          echo ""
          echo "Verifying sidecar injection..."
          CONTAINERS=$(kubectl get pod -l app=httpbin -n ingress-sample -o jsonpath='{.items[0].spec.containers[*].name}')
          echo "Containers: $CONTAINERS"
          if echo "$CONTAINERS" | grep -q "istio-proxy"; then
            echo "SUCCESS: Sidecar injected!"
          else
            echo "FAILURE: Sidecar not found"
            kubectl describe pod -l app=httpbin -n ingress-sample
            exit 1
          fi

      - name: Test HTTP to HTTPS redirect
        run: |
          echo "Testing HTTP redirect (port 8080)..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -H "Host: httpbin.localhost" http://localhost:8080/get || true)
          echo "HTTP response code: $RESPONSE"
          # 301 or 308 redirect expected
          if [ "$RESPONSE" = "301" ] || [ "$RESPONSE" = "308" ]; then
            echo "SUCCESS: HTTP redirects to HTTPS"
          else
            echo "FAILURE: Expected redirect (301/308), got $RESPONSE"
            echo "Gateway logs:"
            kubectl logs -n istio-ingress deployment/istio-ingress --tail=20 || true
            exit 1
          fi

      - name: Test HTTPS ingress
        run: |
          echo "Testing HTTPS ingress (port 8443)..."
          # Use -k to accept self-signed cert
          RESPONSE=$(curl -sk -H "Host: httpbin.localhost" https://localhost:8443/get)
          echo "Response: $RESPONSE"
          if echo "$RESPONSE" | jq -e '.url' >/dev/null 2>&1; then
            echo "SUCCESS: HTTPS ingress working!"
          else
            echo "FAILURE: Invalid response"
            echo "Gateway logs:"
            kubectl logs -n istio-ingress deployment/istio-ingress --tail=20 || true
            exit 1
          fi

      - name: Test httpbin endpoints
        run: |
          echo "Testing /headers endpoint..."
          curl -sk -H "Host: httpbin.localhost" https://localhost:8443/headers | jq .
          echo ""
          echo "Testing /status/200 endpoint..."
          STATUS=$(curl -sk -o /dev/null -w "%{http_code}" -H "Host: httpbin.localhost" https://localhost:8443/status/200)
          if [ "$STATUS" = "200" ]; then
            echo "SUCCESS: Status endpoint returns 200"
          else
            echo "FAILURE: Expected 200, got $STATUS"
            exit 1
          fi

      - name: Test idempotency
        run: |
          echo "Running cert-manager-up again..."
          make cert-manager-up
          echo "Running ingress-up again..."
          make ingress-up
          echo "Running sample-app-up again..."
          make sample-app-up
          echo "Idempotency tests passed!"

      - name: Cleanup
        if: always()
        run: |
          make sample-app-down || true
          make ingress-down || true
          make cert-manager-down || true
          make istio-down || true
          make cluster-down

  minio-test:
    name: Minio Object Storage Tests
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install prerequisites
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          k3d version
          helm version
          jq --version

      - name: Create k3d cluster
        run: make cluster-up

      - name: Install Minio
        run: make minio-up

      - name: Verify Minio is ready
        run: |
          echo "Checking Minio pods..."
          kubectl get pods -n minio
          kubectl wait --for=condition=Ready pods -l release=minio -n minio --timeout=180s
          echo ""
          echo "Checking services..."
          kubectl get svc -n minio
          echo ""
          echo "Checking PVCs..."
          kubectl get pvc -n minio

      - name: Verify buckets are created
        run: |
          echo "Waiting for bucket creation job to complete..."
          # Give the job some time to run
          sleep 30
          kubectl get jobs -n minio || true
          echo ""
          echo "Checking Minio logs for bucket info..."
          kubectl logs -n minio -l release=minio --tail=50 || true

      - name: Test Minio health endpoint
        run: |
          echo "Testing Minio health endpoint..."
          kubectl run minio-health-check \
            --image=curlimages/curl:latest \
            --restart=Never \
            --rm -i --quiet \
            --namespace minio \
            -- curl -s "http://minio.minio.svc.cluster.local:9000/minio/health/live"
          echo ""
          echo "Health check passed!"

      - name: Test S3 operations
        run: |
          echo "Testing S3 put/get operations..."
          kubectl run minio-s3-test \
            --image=minio/mc:latest \
            --restart=Never \
            --rm -i \
            --namespace minio \
            --env="MC_HOST_myminio=http://minioadmin:minioadmin123@minio.minio.svc.cluster.local:9000" \
            -- sh -c "
              echo 'CI test content' | mc pipe myminio/loki-chunks/ci-test.txt && \
              mc cat myminio/loki-chunks/ci-test.txt && \
              mc rm myminio/loki-chunks/ci-test.txt && \
              echo 'S3 operations test passed!'
            " || echo "S3 test completed (may have warnings)"

      - name: Test idempotency
        run: |
          echo "Running minio-up again to verify idempotency..."
          make minio-up
          echo "Idempotency test passed!"

      - name: Cleanup
        if: always()
        run: |
          make minio-down || true
          make cluster-down

  velero-test:
    name: Velero Backup Tests
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install prerequisites
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          k3d version
          helm version
          jq --version

      - name: Create k3d cluster
        run: make cluster-up

      - name: Install Minio (required for Velero storage)
        run: make minio-up

      - name: Wait for Minio to be ready
        run: |
          echo "Waiting for Minio..."
          kubectl wait --for=condition=Ready pods -l release=minio -n minio --timeout=180s
          sleep 30

      - name: Install Velero
        run: make velero-up

      - name: Verify Velero is ready
        run: |
          echo "Checking Velero pods..."
          kubectl get pods -n velero
          kubectl wait --for=condition=Available deployment/velero -n velero --timeout=180s
          echo ""
          echo "Checking backup storage location..."
          kubectl get backupstoragelocation -n velero

      - name: Test backup storage location
        run: |
          echo "Waiting for backup storage location to become available..."
          for i in {1..20}; do
            PHASE=$(kubectl get backupstoragelocation default -n velero -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")
            echo "Attempt $i: Phase = $PHASE"
            if [ "$PHASE" = "Available" ]; then
              echo "SUCCESS: Backup storage location is Available"
              exit 0
            fi
            sleep 5
          done
          echo "WARNING: Backup storage location not Available after waiting"
          kubectl describe backupstoragelocation default -n velero || true

      - name: Test creating a backup
        run: |
          echo "Creating test namespace..."
          kubectl create namespace velero-ci-test
          kubectl apply -n velero-ci-test -f - <<EOF
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: test-config
          data:
            test-key: "test-value"
          EOF

          echo "Creating backup..."
          kubectl exec -n velero deploy/velero -- \
            /velero backup create ci-test-backup \
            --include-namespaces velero-ci-test \
            --wait || echo "Backup command completed"

          echo "Checking backup status..."
          kubectl get backup -n velero

      - name: Test idempotency
        run: |
          echo "Running velero-up again to verify idempotency..."
          make velero-up
          echo "Idempotency test passed!"

      - name: Cleanup
        if: always()
        run: |
          kubectl delete namespace velero-ci-test --ignore-not-found=true || true
          make velero-down || true
          make minio-down || true
          make cluster-down
