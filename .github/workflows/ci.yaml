name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate YAML syntax
        run: |
          echo "Checking for YAML syntax errors..."
          find . -name '*.yaml' -o -name '*.yml' | while read file; do
            python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null || echo "Warning: $file may have issues"
          done
          echo "YAML validation complete"

      - name: Validate Makefile exists
        run: |
          test -f Makefile && echo "Makefile exists" || exit 1

      - name: Show make targets
        run: make help

  # Single integration test - one cluster for all platform components
  integration-test:
    name: Full Stack Integration
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 35
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install prerequisites
        run: |
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          k3d version
          helm version
          jq --version

      - name: Create k3d cluster
        run: make cluster-up

      # ===== PLATFORM LAYER =====
      - name: Install Istio
        run: make istio-up

      - name: Verify Istio
        run: |
          kubectl wait --for=condition=Ready pods --all -n istio-system --timeout=120s
          kubectl wait --for=condition=Ready pods --all -n istio-ingress --timeout=120s
          # Verify mTLS
          MTLS_MODE=$(kubectl get peerauthentication default -n istio-system -o jsonpath='{.spec.mtls.mode}')
          [ "$MTLS_MODE" = "STRICT" ] && echo "mTLS STRICT verified"

      - name: Install cert-manager
        run: make cert-manager-up

      - name: Verify cert-manager
        run: |
          kubectl wait --for=condition=Ready pods --all -n cert-manager --timeout=120s
          kubectl wait --for=condition=Ready clusterissuer/selfsigned-issuer --timeout=60s
          kubectl wait --for=condition=Ready clusterissuer/automation-ca-issuer --timeout=60s

      - name: Configure ingress
        run: make ingress-up

      - name: Verify ingress certificate
        run: |
          kubectl wait --for=condition=Ready certificate/gateway-tls -n istio-ingress --timeout=120s
          kubectl get secret gateway-tls-secret -n istio-ingress

      - name: Install Minio
        run: make minio-up

      - name: Verify Minio
        run: |
          kubectl wait --for=condition=Ready pods -l release=minio -n minio --timeout=180s
          sleep 20  # Wait for bucket creation
          kubectl run minio-health \
            --image=curlimages/curl:latest \
            --restart=Never --rm -i --quiet \
            --namespace minio \
            -- curl -sf "http://minio.minio.svc.cluster.local:9000/minio/health/live"
          echo "Minio healthy"

      # ===== SAMPLE APP TEST =====
      - name: Deploy sample app
        run: make sample-app-up

      - name: Test ingress routing
        run: |
          kubectl wait --for=condition=Ready pods -l app=httpbin -n ingress-sample --timeout=120s
          # Test HTTPS
          RESPONSE=$(curl -sk -H "Host: httpbin.localhost" https://localhost:8443/get)
          echo "$RESPONSE" | jq -e '.url' && echo "HTTPS routing verified"
          # Verify sidecar injection
          CONTAINERS=$(kubectl get pod -l app=httpbin -n ingress-sample -o jsonpath='{.items[0].spec.containers[*].name}')
          echo "$CONTAINERS" | grep -q "istio-proxy" && echo "Sidecar injection verified"

      # ===== OBSERVABILITY LAYER =====
      - name: Install Prometheus + Grafana
        run: make prometheus-grafana-up

      - name: Verify Prometheus + Grafana
        run: |
          kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=prometheus -n observability --timeout=180s || true
          kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=grafana -n observability --timeout=180s || true
          kubectl get pods -n observability

      - name: Install Loki
        run: make loki-up

      - name: Verify Loki
        run: |
          kubectl wait --for=condition=Ready pods -l app=loki,release=loki -n observability --timeout=180s
          kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=promtail -n observability --timeout=120s
          kubectl run loki-health \
            --image=curlimages/curl:latest \
            --restart=Never --rm -i --quiet \
            --namespace observability \
            -- curl -sf "http://loki:3100/ready"
          echo "Loki healthy"

      - name: Install Tracing
        run: make tracing-up

      - name: Verify Tracing
        run: |
          kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=tempo -n observability --timeout=180s
          kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=opentelemetry-collector -n observability --timeout=120s
          kubectl run tempo-health \
            --image=curlimages/curl:latest \
            --restart=Never --rm -i --quiet \
            --namespace observability \
            -- curl -sf "http://tempo.observability.svc.cluster.local:3200/ready"
          echo "Tempo healthy"

      # ===== BACKUP LAYER =====
      - name: Install Velero
        run: make velero-up

      - name: Verify Velero
        run: |
          kubectl wait --for=condition=Available deployment/velero -n velero --timeout=180s
          kubectl get backupstoragelocation -n velero
          # Wait for backup storage to be available
          for i in {1..20}; do
            PHASE=$(kubectl get backupstoragelocation default -n velero -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")
            [ "$PHASE" = "Available" ] && echo "Backup storage available" && break
            sleep 5
          done

      # ===== IDEMPOTENCY TESTS =====
      - name: Test idempotency (all components)
        run: |
          echo "Testing idempotency..."
          make istio-up
          make cert-manager-up
          make ingress-up
          make minio-up
          make prometheus-grafana-up
          make loki-up
          make tracing-up
          make velero-up
          echo "All components idempotent!"

      # ===== SUMMARY =====
      - name: Print stack status
        if: always()
        run: |
          echo "=== Final Stack Status ==="
          kubectl get pods -A | grep -v "Completed" || true
          echo ""
          echo "=== Helm Releases ==="
          helm list -A || true

      - name: Cleanup
        if: always()
        run: |
          make sample-app-down || true
          make velero-down || true
          make tracing-down || true
          make loki-down || true
          make prometheus-grafana-down || true
          make minio-down || true
          make ingress-down || true
          make cert-manager-down || true
          make istio-down || true
          make cluster-down
