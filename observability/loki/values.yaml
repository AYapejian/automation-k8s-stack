# Loki-Stack Helm values for k3d
# https://github.com/grafana/helm-charts/tree/main/charts/loki-stack
#
# Bundled Loki + Promtail for simple local development.
# Storage: Minio S3-compatible object storage

# Loki configuration
loki:
  enabled: true
  isDefault: false  # We create our own datasource ConfigMap

  # Resource limits for k3d
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

  # Persistence - disabled (using Minio for storage)
  persistence:
    enabled: false

  # Environment variables for S3 credentials (from secret)
  extraEnvFrom:
    - secretRef:
        name: loki-minio-credentials

  # Loki config overrides
  config:
    auth_enabled: false

    ingester:
      chunk_idle_period: 3m
      chunk_block_size: 262144
      chunk_retain_period: 1m
      max_transfer_retries: 0
      lifecycler:
        ring:
          replication_factor: 1

    limits_config:
      retention_period: 24h
      enforce_metric_name: false
      reject_old_samples: true
      reject_old_samples_max_age: 168h
      max_entries_limit_per_query: 5000

    schema_config:
      configs:
        - from: 2020-10-24
          store: boltdb-shipper
          object_store: s3
          schema: v11
          index:
            prefix: index_
            period: 24h

    storage_config:
      boltdb_shipper:
        active_index_directory: /data/loki/boltdb-shipper-active
        cache_location: /data/loki/boltdb-shipper-cache
        cache_ttl: 24h
        shared_store: s3
      aws:
        endpoint: minio.minio.svc.cluster.local:9000
        bucketnames: loki-chunks
        access_key_id: minioadmin
        secret_access_key: minioadmin123
        insecure: true
        s3forcepathstyle: true

    compactor:
      working_directory: /data/loki/boltdb-shipper-compactor
      shared_store: s3

    table_manager:
      retention_deletes_enabled: true
      retention_period: 24h

# Promtail configuration
promtail:
  enabled: true

  # Resource limits for k3d
  resources:
    requests:
      cpu: 10m
      memory: 64Mi
    limits:
      cpu: 100m
      memory: 128Mi

  # Tolerations to run on all nodes
  tolerations:
    - key: node-role.kubernetes.io/master
      operator: Exists
      effect: NoSchedule
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule

  # Config overrides
  config:
    clients:
      - url: http://{{ .Release.Name }}:3100/loki/api/v1/push

# Disable Grafana (we have our own)
grafana:
  enabled: false

# Disable Prometheus (we have our own)
prometheus:
  enabled: false

# Disable Fluent-bit
fluent-bit:
  enabled: false

# Disable Filebeat
filebeat:
  enabled: false

# Disable Logstash
logstash:
  enabled: false
